:title: XOAUTH2: Secure email delivery with OAuth2
:date: 2025-05-28
:publish: true
:author: [Sebastian Rose]
:summary: Learn how to securely configure SMTP authentication in Keycloak for reliable email delivery using XOAUTH2 mechanism. Explore the the future of sending messages to identities.

Keycloak relies on email functionality for tasks like password resets, user verifications, and notifications.
While SMTP has long been supported without any required changes, authentication demands evolved.

With link:https://github.com/keycloak/keycloak/issues/17432[Issue #17432] the Keycloak community raised the need for XOAUTH2.
As described in the issue, the authentication mechanism of a plain password was announced to be deprecated a while ago.

This has led to extend the SMTP AUTH configuration in Keycloak 26.2.!
For XAUTH2 a user and a token must be passed to the underlying mail-library.
This token must be gathered before.
As Keycloaks role is an application, Client Credentials Grant is used.
The SMTP AUTH configuration in Keycloak now supports all required fields to gather a token with client id and client secret.

== Why this is probably not the final solution?

While implementing XOAUTH2 I learned a lot more details on how emails are seen from the modern Cloud-Providers perspective.
Another big impulse came from discussions during the link:https://www.keycloak-day.dev/[Keycloak DevDay 2025] Hackathon.
I would like to break apart what happens when we talk about the current email functionality of Keycloak.

What happens, and what will be required to happen for probably all coming days of Keycloak, is sending a message of any format to an identity.
This message could be any format and building a message could be seperated from the actual delivery of that message.
Second, an identity could have all kinds of message handles and probably email is not the only one of interest.
Also, the way an email is sent might no longer be the Simple Mail Transfer Protocol in a cloud world, but some HTTP+Json based API.

But one step after the other.

== XOAUTH2 configuration in Keycloak

In a realm, navigate to `Realm Settings -> Email` and fill in the fields.

To see the new XOAUTH2 feature enable `authentication` via radio-button and switch from `password` to `token` in the next section.
Further details can be found in the documentation on https://www.keycloak.org/docs/latest/server_admin/index.html#_email[sending emails].

--
++++
<div class="paragraph">
</style>
<img src="${blogImages}/smtp-xoauth2-26-2.png" alt="Settings for token based authentication" style="width: 100%; max-width: 863px; object-fit: cover; object-fit: none; object-position: 0 0">
</div>
++++
--

Once all the necessary settings for gathering an access token and the username to be used for authentication are saved, you can test the configuration via the built-in "Test connection" button.

As I learned through testing with real providers of XOAUTH2: only Microsoft can be used with the introduced changes and gather an XOAUTH2 token through a Client Credentials Grant using a client secret.

As the documentation already states: Sending an email with Google would require implementing token gathering through a Client Credentials Grant using a JWT Token.
This JWT Token for authenticating the client must be fetched before using some other call to a token endpoint.
During some experiments I already learned: the configuration of a Google Enterprise account seems to have no possibility to restrict the sender email address, so the CEO's email address could be configured using this configuration.
This feels wrong, but it could be argued to not solve this on Keycloak's end.

Code refactoring will probably bring provider-specific configuration screens, as it feels not right to stick to all combinations of token gathering mechanisms combined with the client configuration possibilities.
Please vote on https://github.com/keycloak/keycloak/issues/39610[this issue] to bring Google with SMTP and XOAUTH2.

== Conclusion

To me, this feels like fiddling with a fax-machine while everyone else just sends a photo using a mobile phone.
So what might be other steps for the bright future of Keycloak in regard to sending messages to identities?

Cloud providers and probably many more provide HTTP based messaging APIs which can be used to send someone an email without using SMTP.
Looking at these and remembering the discussions from the Keycloak DevDay 2025 Hackathon: Why use email addresses at all?
An identity could be reached by all kinds of handles.
In some parts of the planet, only mobile phones are used to reach out to somebody.
In development scenarios, even a chat-message to, for example, Slack might be enough.

I started a discussion about the link:https://github.com/keycloak/keycloak/discussions/37848[Future of sending messages to identities in Keycloak]. Please join the discussion and let me know what you think.

